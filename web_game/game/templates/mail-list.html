{% extends 'layout.html' %}
{% load humanize %}
{% block content %}
<script>
var senders=new Array();
{% if mail %}{% if reply %}senders.push(new Array({{from:quote}},{{index}},{% if ignore %}false{% endignore %}{% if ignored %}true{% endignored %}));{% endreply %}{% endmail %}

function updatebg(index, event) {
	var list = document.getElementsByName("checked_mails");
	var obj = list[index];
	document.getElementById("mail"+index).className = (obj.checked?"itemdel":"item");
}
function check(index, event) {
	var list = document.getElementsByName("checked_mails");

	if(event.ctrlKey)
	{
		for(;index<list.length;index++)
		{
			var obj=list[index];
			obj.checked=true;
			updatebg(index);
		}
	}
	else
	{
		var obj=list[index];
		obj.checked=!obj.checked;
		updatebg(index);
	}
}
function donotclick(index, event){{ updatebg(index, event); event.cancelBubble = true; }}

function ignore(name){
	if(confirm('Êtes-vous sûr de vouloir bloquer les messages en provenance du joueur "' + name + '" ?'))
		openURL("/game/mails/?a=ignore&user="+name, evalResponse);
	return false;
}
function unignore(name){
	openURL("/game/mails/?a=unignore&user="+name, evalResponse);
	return false;
}
{% if comment %}reset ignored status of senders{% endcomment %}
function resetIgnoredUsers(){{ for(var i=0;i<senders.length;i++) senders[i][2] = false; }}

{% if comment %}set the status of a user to ignored{% endcomment %}
function setIgnored(name){{ for(var i=0;i<senders.length;i++) if(senders[i][0] == name) senders[i][2] = true; }}

function updateUsers() {
	var i,obj;

	for(i=0;i<senders.length;i++)
	{
		obj = document.getElementById("ignore_"+senders[i][1]);
		if(obj) obj.className = (senders[i][2]?"hidden":"");

		obj = document.getElementById("ignored_"+senders[i][1]);
		if(obj) obj.className = (senders[i][2]?"":"hidden");
	}
}

function keydown(event) {
	if(document.all)
		var x = window.event.keyCode;
	else
		var x = event.keyCode;
	if(x == 46) document.getElementById("delbtn").click();
}
document.onkeydown = keydown;
</script>

<div id="mails">
<form method="post" action="?start={{offset}}" id="mailsform">{% csrf_token %}
<table class="default" width="100%">

<tr class="title"><td colspan=3>Messages reçus</td></tr>

{% if nav %}<tr class="nav"><td colspan=3 align=left>Page {{page_display}}, Messages {{min}}-{{max}}. Aller à
{% if p %}&nbsp;{% if link %}<a href="?start={{page_link}}">{% endlink %}{% if selected %}<span class="selected">{% endif %}{{page_id}}{% if selected %}</span>{% endif %}{% if link %}</a>{% endlink %}{% endfor %}.
</td></tr>{% endif %}

{% if mail %}
<tr id="mail{{index}}" class="item{% if new_mail %}highlight{% endnew_mail %}">
	<td width="1%" rowspan=1 align=center valign=top onclick="check({{index}},event)">
		<input type="checkbox" class="checkbox" name="checked_mails" value="{{mailid}}" onclick="donotclick({{index}},event)">
	</td>
	<td width="1%" rowspan=1 align=center valign=top nowrap>
	{% if reply %}<a href="/game/nation/?name={{from}}" title="Informations sur {{from}}">{% endreply %}
	{% if avatar %}<img src="{{avatar_url}}" width=64 height=64 class="avatar">{% endavatar %}
	{% if noavatar %}<img src="{{PATH_IMAGES}}/interface/noavatar.gif" width=64 height=64 class="avatar">{% endnoavatar %}
	<br/><b>{{from}}</b>
	{% if reply %}</a>
	{% if alliance %}<br/><a href="/game/alliance/?tag={{alliancetag}}">[{{alliancetag}}]</a><br/>{% endif %}
	<div id="ignore_{{index}}"{% if ignored %} class=hidden{% endignored %}><a href="#" onclick="return ignore({{from:quote}})" title="Bloque les futurs messages provenant de ce joueur">Bloquer</a></div>
	<div id="ignored_{{index}}"{% if ignore %} class=hidden{% endignore %}><a href="#" onclick="return unignore({{from:quote}})"><span class=error>Bloqué</span></a></div>
	{% endreply %}
	{% if admin %}
	<div><a href="/game/dev-playas/?player={{from}}">Impersonate</a></div>
	{% endadmin %}
	</td>
	<td valign="top">
	<div class="subject">
	{{date:dd/mm/yyyy hh:nn:ss}} | {{subject}}{% if money %} | Somme reçue : <img src="{{PATH_IMAGES}}/interface/credits.gif" title="Crédits" class="icon" width=16 height=16> {{moneyamount|intcomma}}{% endmoney %} {% if to_admins %}(Aux administrateurs){% endto_admins %}{% if to_alliance %}(À l'alliance){% endto_alliance %}</div>
	<div class="body{% if from_admin %}{% endfrom_admin %}">{% if html %}{{body}}{% endhtml %}{% if bbcode %}{{bodybb|bbcode}}{% endbbcode %}</div>
	<hr/><a href="?a=reply&mailid={{mailid}}" title="Répondre à {{from}}">Répondre</a>
	</td>
</tr>
{% endfor %}
{% if nomails %}<tr><td colspan=3 align=center>Aucun</td></tr>{% endnomails %}

<tr>
	<td colspan=3 class=buttons>
		<input type="submit" class="button100" name="delete" value="Supprimer" id="delbtn">&nbsp;<input type="button" class="button100" name="compose" value="Nouveau >" onclick="javascript:window.location.href='?a=new'">
	</td>
</tr>

{% if nav %}<tr class="nav"><td colspan=3 align=left>Page {{page_display}}, Messages {{min}}-{{max}}. Aller à
{% if p %}&nbsp;{% if link %}<a href="?start={{page_link}}">{% endlink %}{% if selected %}<span class="selected">{% endif %}{{page_id}}{% if selected %}</span>{% endif %}{% if link %}</a>{% endlink %}{% endfor %}.
</td></tr>{% endif %}

</table>
</form>
</div>
{% endblock %}